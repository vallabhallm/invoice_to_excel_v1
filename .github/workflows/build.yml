name: Build Distributions

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'poetry'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr
    
    - name: Install dependencies
      run: |
        poetry install --no-interaction
    
    - name: Run tests
      run: |
        poetry run pytest tests/test_models.py tests/test_extractors.py tests/test_basic.py --cov=src/invoice_processor --cov-report=xml
    
    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml

  build-macos:
    needs: test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        brew install create-dmg imagemagick tesseract
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install pyinstaller
        # Install all required dependencies manually
        # Prefect removed for PyInstaller compatibility
        pip install "pydantic>=2.5.0"
        pip install "opencv-python>=4.8.1"
        pip install "pytesseract>=0.3.10"
        pip install "PyPDF2>=3.0.1"
        pip install "pdf2image>=1.16.3"
        pip install "pillow>=10.1.0"
        pip install "openai>=1.6.0"
        pip install "anthropic>=0.8.0"
        pip install "pandas>=2.1.4"
        pip install "python-dotenv>=1.0.0"
        pip install "typer>=0.13.0"
        pip install "rich>=13.7.0"
        pip install -e .
    
    - name: Create app icon
      run: |
        mkdir -p cd/assets/icons
        # Create a simple PNG icon if ImageMagick is available
        if command -v magick >/dev/null 2>&1; then
          magick -size 512x512 xc:'#2E86AB' -fill white -gravity center -font Helvetica-Bold -pointsize 120 -annotate +0-20 'IP' cd/assets/icons/app.png
          magick cd/assets/icons/app.png cd/assets/icons/app.icns
        else
          # Create a simple text file as fallback
          echo "IP" > cd/assets/icons/app.icns
        fi

    - name: Build macOS application
      run: |
        # Create a simple build directory
        mkdir -p cd/dist
        
        # Create a very basic PyInstaller spec file
        cat > cd/simple_macos.spec << 'EOF'
        # -*- mode: python ; coding: utf-8 -*-
        import sys
        from pathlib import Path

        a = Analysis(
            ['../src/invoice_processor/main.py'],
            pathex=[],
            binaries=[],
            datas=[],
            hiddenimports=[
                'invoice_processor',
                'invoice_processor.main',
                'invoice_processor.models',
                'invoice_processor.extractors',
                'invoice_processor.utils',
                'invoice_processor.workflows',
                'pydantic',
                # 'prefect', # Removed for PyInstaller compatibility
                'typer',
                'rich',
                'openai',
                'anthropic',
                'pytesseract',
                'PIL',
                'cv2',
                'pandas',
                'dotenv',
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=None,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=None)

        exe = EXE(
            pyz,
            a.scripts,
            [],
            exclude_binaries=True,
            name='InvoiceProcessor',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
        )

        coll = COLLECT(
            exe,
            a.binaries,
            a.zipfiles,
            a.datas,
            strip=False,
            upx=True,
            upx_exclude=[],
            name='InvoiceProcessor',
        )

        app = BUNDLE(
            coll,
            name='InvoiceProcessor.app',
            icon=None,
            bundle_identifier='com.invoiceprocessor.app',
        )
        EOF
        
        # Build with the spec file
        cd cd && pyinstaller simple_macos.spec

    - name: Create DMG
      run: |
        if command -v create-dmg >/dev/null 2>&1; then
          create-dmg \
            --volname "Invoice Processor" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            cd/dist/InvoiceProcessor-1.0.0-macOS.dmg \
            cd/dist/InvoiceProcessor.app
        else
          echo "create-dmg not available, skipping DMG creation"
          # Just create a zip as fallback
          cd cd/dist && zip -r InvoiceProcessor-1.0.0-macOS.zip InvoiceProcessor.app
        fi
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: |
          cd/dist/*.dmg
          cd/dist/*.zip
        retention-days: 30

  build-windows:
    needs: test
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install pyinstaller
        # Install all required dependencies manually
        # Prefect removed for PyInstaller compatibility
        pip install "pydantic>=2.5.0"
        pip install "opencv-python>=4.8.1"
        pip install "pytesseract>=0.3.10"
        pip install "PyPDF2>=3.0.1"
        pip install "pdf2image>=1.16.3"
        pip install "pillow>=10.1.0"
        pip install "openai>=1.6.0"
        pip install "anthropic>=0.8.0"
        pip install "pandas>=2.1.4"
        pip install "python-dotenv>=1.0.0"
        pip install "typer>=0.13.0"
        pip install "rich>=13.7.0"
        pip install -e .
    
    - name: Install Windows dependencies
      run: |
        # Install ImageMagick and Tesseract on Windows
        choco install imagemagick tesseract --yes
    
    - name: Create app icon
      shell: bash
      run: |
        mkdir -p cd/assets/icons
        # Create a simple PNG icon if ImageMagick is available
        if command -v magick >/dev/null 2>&1; then
          magick -size 512x512 xc:'#2E86AB' -fill white -gravity center -font Helvetica-Bold -pointsize 120 -annotate +0-20 'IP' cd/assets/icons/app.png
          magick cd/assets/icons/app.png cd/assets/icons/app.ico
        else
          # Create a simple text file as fallback
          echo "IP" > cd/assets/icons/app.ico
        fi

    - name: Build Windows executable
      shell: bash
      run: |
        # Create a simple build directory
        mkdir -p cd/dist
        
        # Create a PyInstaller spec file optimized for Windows console applications
        cat > cd/simple_windows.spec << 'EOF'
        # -*- mode: python ; coding: utf-8 -*-
        import sys
        from pathlib import Path

        a = Analysis(
            ['../src/invoice_processor/main.py'],
            pathex=[],
            binaries=[],
            datas=[],
            hiddenimports=[
                'invoice_processor',
                'invoice_processor.main',
                'invoice_processor.models',
                'invoice_processor.extractors',
                'invoice_processor.utils',
                'invoice_processor.workflows',
                'pydantic',
                'typer',
                'rich',
                'rich.console',
                'rich.text',
                'rich.logging',
                'rich.progress',
                'openai',
                'anthropic',
                'pytesseract',
                'PIL',
                'cv2',
                'pandas',
                'dotenv',
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=None,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=None)

        exe = EXE(
            pyz,
            a.scripts,
            [],
            exclude_binaries=True,
            name='InvoiceProcessor',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            console=True,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
        )

        coll = COLLECT(
            exe,
            a.binaries,
            a.zipfiles,
            a.datas,
            strip=False,
            upx=True,
            upx_exclude=[],
            name='InvoiceProcessor',
        )
        EOF
        
        # Create test scripts first
        cat > test_windows_exe.bat << 'EOF'
        @echo off
        echo Testing Windows executable...
        echo.
        
        echo Test 1: Running with --help flag:
        echo ----------------------------------------
        InvoiceProcessor\InvoiceProcessor.exe --help
        echo.
        echo Exit code: %ERRORLEVEL%
        echo.
        
        echo Test 2: Running with --version flag:
        echo ----------------------------------------
        InvoiceProcessor\InvoiceProcessor.exe --version
        echo.
        echo Exit code: %ERRORLEVEL%
        echo.
        
        echo Test 3: Running status command:
        echo ----------------------------------------
        InvoiceProcessor\InvoiceProcessor.exe status
        echo.
        echo Exit code: %ERRORLEVEL%
        echo.
        
        echo Test 4: Check if executable exists and is readable:
        echo ----------------------------------------
        dir InvoiceProcessor\
        echo.
        
        pause
        EOF
        
        cat > test_windows_exe.ps1 << 'EOF'
        Write-Host "Testing Windows executable with PowerShell..." -ForegroundColor Green
        Write-Host ""
        
        Write-Host "Test 1: Running with --help flag:" -ForegroundColor Yellow
        Write-Host "----------------------------------------"
        & ".\InvoiceProcessor\InvoiceProcessor.exe" --help
        Write-Host "Exit code: $LASTEXITCODE"
        Write-Host ""
        
        Write-Host "Test 2: Running with --version flag:" -ForegroundColor Yellow
        Write-Host "----------------------------------------"
        & ".\InvoiceProcessor\InvoiceProcessor.exe" --version
        Write-Host "Exit code: $LASTEXITCODE"
        Write-Host ""
        
        Write-Host "Test 3: Running status command:" -ForegroundColor Yellow
        Write-Host "----------------------------------------"
        & ".\InvoiceProcessor\InvoiceProcessor.exe" status
        Write-Host "Exit code: $LASTEXITCODE"
        Write-Host ""
        
        Read-Host "Press Enter to continue"
        EOF
        
        # Build with the spec file
        cd cd && pyinstaller simple_windows.spec
        
        # Move test scripts to dist directory
        mv test_windows_exe.bat cd/dist/
        mv test_windows_exe.ps1 cd/dist/
        
        # Create a zip file for distribution
        cd cd/dist && powershell Compress-Archive -Path "InvoiceProcessor","test_windows_exe.bat","test_windows_exe.ps1" -DestinationPath "InvoiceProcessor-Windows.zip"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe
        path: |
          cd/dist/InvoiceProcessor-Windows.zip
          cd/dist/test_windows_exe.bat
          cd/dist/test_windows_exe.ps1
        retention-days: 30

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-dmg
        path: ./dist/
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-exe
        path: ./dist/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./dist/*.dmg
          ./dist/*.zip
        body: |
          ## Invoice Processor ${{ github.ref_name }}
          
          ### 📦 Downloads
          
          - **macOS**: Download the `.dmg` file
          - **Windows**: Download the `.exe` file
          
          ### 🚀 Installation
          
          #### macOS
          1. Download the DMG file
          2. Open the DMG and drag the app to Applications
          3. Run the app from Applications folder
          
          #### Windows
          1. Download the EXE file
          2. Run the installer as administrator
          3. Follow the installation wizard
          
          ### 📋 Requirements
          
          - **macOS**: macOS 10.14+ (Mojave or later)
          - **Windows**: Windows 10/11 (64-bit)
          - **Optional**: OpenAI and/or Anthropic API keys for AI processing
          
          ### 🔧 Configuration
          
          After installation, configure your API keys through the application settings or by editing the `.env` file.
          
          For detailed instructions, see the [README](https://github.com/vallabhallm/invoice_to_excel_v1/blob/main/README.md).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}